<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocorido</title>
    
    <link rel="stylesheet" href="style/main.css">
    
</head>
<body>

    <div id="zona-giocatori-sidebar">
        <h2>Players</h2>
        <div id="lista-giocatori-container"></div>
    </div>
    
    <div id="contenitore-principale">
        
        <h1 id="titolo-gioco">Cocorido</h1> 
        
        <div id="chat-container">
            <h3>Chat</h3>
            <div id="chat-messaggi-lista">
                </div>
            <form id="chat-form">
                <input id="chat-input" type="text" placeholder="Say something..." autocomplete="off">
                <button type="submit">Send</button>
            </form>
        </div>
        
        <button id="chat-toggle-btn">üí¨</button>

        <h2 id="stato-connessione">Disconnected ‚ùå</h2>
        
        <div id="zona-profilo-giocatore" style="display: none;">
            <h3>Your Profile</h3>
            <div class="profilo-nome-container">
                <span id="profilo-nome-testo"></span>
                <input type="text" id="profilo-nome-input" style="display: none;" />
                <span id="profilo-edit-icon" class="profilo-edit-icon">‚úèÔ∏è</span>
            </div>
        </div>
        
        <div id="zona-lobby">
            <h3>Lobby</h3>
            <p id="lobby-conteggio">Waiting for players...</p>
            <p id="lobby-attesa-host"></p>
        </div>

        <button id="btn-inizia" style="display: none;">START GAME</button>
        <div id="area-messaggi"></div>

        <div id="area-gioco">
            <div id="zona-master"></div>
            <div id="zona-carta-nera">
                <div class="carta-nera" id="testo-carta-nera"></div>
                <p id="info-master"></p>
            </div>
            
            <div id="zona-carte-giocate"></div>
            <button id="btn-attiva-scelta" style="display: none;">Choose Winner</button>
            <div id="zona-mano-giocatore"></div>
        </div>

    </div> 

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Elementi HTML
        const statoConnessioneEl = document.getElementById('stato-connessione');
        const btnInizia = document.getElementById('btn-inizia');
        const areaMessaggi = document.getElementById('area-messaggi');
        const titoloGiocoEl = document.getElementById('titolo-gioco');
        
        const contenitorePrincipale = document.getElementById('contenitore-principale');
        
        const zonaMaster = document.getElementById('zona-master');
        const zonaCartaNera = document.getElementById('zona-carta-nera');
        const testoCartaNera = document.getElementById('testo-carta-nera');
        const infoMaster = document.getElementById('info-master');
        const zonaManoGiocatore = document.getElementById('zona-mano-giocatore');
        const zonaCarteGiocate = document.getElementById('zona-carte-giocate'); 
        const listaGiocatoriContainer = document.getElementById('lista-giocatori-container');
        const zonaLobby = document.getElementById('zona-lobby');
        const lobbyConteggio = document.getElementById('lobby-conteggio');
        const lobbyAttesaHost = document.getElementById('lobby-attesa-host');
        const btnAttivaScelta = document.getElementById('btn-attiva-scelta');
        
        const zonaProfiloGiocatore = document.getElementById('zona-profilo-giocatore');
        const profiloNomeTesto = document.getElementById('profilo-nome-testo');
        const profiloEditIcon = document.getElementById('profilo-edit-icon');
        const profiloNomeInput = document.getElementById('profilo-nome-input');
        
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessaggiLista = document.getElementById('chat-messaggi-lista');
        const chatToggleBtn = document.getElementById('chat-toggle-btn');

        // Stato locale
        let mioRuolo = { isMaster: false };
        let mioStato = { inAttesa: false }; 
        let listaGiocatoriLocale = []; 
        let masterCorrenteID = null;
        
        let countdownInterval = null;
        let isChatOpen = false; 

        function getNomeGiocatore(id) {
            const giocatore = listaGiocatoriLocale.find(g => g.id === id);
            return giocatore ? giocatore.nome : "Player...";
        }
        
        function attivaModificaNome() {
            profiloNomeTesto.style.display = 'none';
            profiloNomeInput.style.display = 'inline-block';
            profiloNomeInput.value = profiloNomeTesto.textContent;
            profiloNomeInput.focus();
            profiloEditIcon.textContent = '‚úÖ';
        }
        
        function salvaModificaNome() {
            const nuovoNome = profiloNomeInput.value;
            const nomeAttuale = profiloNomeTesto.textContent;
            
            if (nuovoNome && nuovoNome !== nomeAttuale) {
                socket.emit('imposta-nome', nuovoNome);
            }
            
            profiloNomeInput.style.display = 'none';
            profiloNomeTesto.style.display = 'inline-block';
            profiloEditIcon.textContent = '‚úèÔ∏è';
        }

        // --- Funzione per aprire/chiudere la chat (MODIFICATA) ---
        function toggleChat() {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                chatContainer.classList.add('aperta');
                contenitorePrincipale.classList.add('chat-attiva'); // Spinge il contenuto
                chatToggleBtn.classList.add('chat-aperta'); // Sposta il bottone
                chatToggleBtn.classList.remove('has-new-messages'); // Rimuovi notifica
                chatMessaggiLista.scrollTop = chatMessaggiLista.scrollHeight; // Scrolla in fondo
                chatInput.focus();
            } else {
                chatContainer.classList.remove('aperta');
                contenitorePrincipale.classList.remove('chat-attiva'); // Rilascia il contenuto
                chatToggleBtn.classList.remove('chat-aperta'); // Rimette il bottone a posto
            }
        }

        // --- GESTIONE CONNESSIONE ---
        socket.on('connect', () => {
            statoConnessioneEl.style.display = 'none';
        });
        
        socket.on('disconnect', () => {
            statoConnessioneEl.style.display = 'block';
            statoConnessioneEl.style.color = 'red';
        });

        btnInizia.addEventListener('click', () => {
            socket.emit('inizia-partita');
            btnInizia.style.display = 'none'; 
        });

        socket.on('errore', (messaggio) => {
            areaMessaggi.innerHTML = `<p style="color: red;">${messaggio}</p>`;
        });
        
        btnAttivaScelta.addEventListener('click', () => {
            btnAttivaScelta.style.display = 'none';
            zonaMaster.textContent = "Choose the winning card!";
            const carteRivelate = zonaCarteGiocate.querySelectorAll('.carta-bianca');
            carteRivelate.forEach(cartaDiv => {
                cartaDiv.className = 'carta-scelta';
                cartaDiv.onclick = () => {
                    const testoScelto = cartaDiv.dataset.testo;
                    console.log("Master has chosen:", testoScelto);
                    socket.emit('scegli-vincitore', testoScelto); 
                    zonaCarteGiocate.innerHTML = `<p style="font-size: 1.5em; color: green;">You chose! Announcing winner...</p>`;
                };
            });
        });
        
        profiloEditIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            if (profiloEditIcon.textContent === '‚úèÔ∏è') {
                attivaModificaNome();
            } else {
                salvaModificaNome();
            }
        });
        
        profiloNomeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                salvaModificaNome();
            }
        });
        profiloNomeInput.addEventListener('blur', () => {
            if (profiloNomeInput.style.display !== 'none') {
                salvaModificaNome();
            }
        });

        chatToggleBtn.addEventListener('click', toggleChat); 

        // --- GESTIONE LISTA GIOCATORI ---
        socket.on('aggiorna-lista-giocatori', (data) => {
            const { giocatori, hostID, partitaInCorso } = data;
            listaGiocatoriLocale = giocatori; 
            listaGiocatoriContainer.innerHTML = ''; 
            
            giocatori.forEach(g => {
                const giocatoreDiv = document.createElement('div');
                giocatoreDiv.className = 'giocatore-sidebar-item'; 
                const nomeDiv = document.createElement('div');
                nomeDiv.className = 'giocatore-nome';
                let nomeTesto = g.nome;
                if (g.id === hostID) {
                    nomeTesto = `üëë ${nomeTesto}`;
                }
                nomeDiv.textContent = nomeTesto;
                giocatoreDiv.appendChild(nomeDiv);
                
                const puntiDiv = document.createElement('div');
                puntiDiv.className = 'giocatore-punti';
                puntiDiv.textContent = `Points: ${g.punti}`;
                giocatoreDiv.appendChild(puntiDiv);
                
                if (g.id === socket.id) {
                    giocatoreDiv.classList.add('tu');
                }
                if (g.inAttesa) {
                    giocatoreDiv.classList.add('in-attesa');
                } else if (g.id === masterCorrenteID) {
                    giocatoreDiv.classList.add('master-turno');
                } else if (g.haGiocato) {
                    giocatoreDiv.classList.add('ha-giocato');
                }
                listaGiocatoriContainer.appendChild(giocatoreDiv);
            });
            
            const mioDato = giocatori.find(g => g.id === socket.id);

            if (!partitaInCorso) {
                zonaLobby.style.display = 'block';
                titoloGiocoEl.style.display = 'block';
                chatToggleBtn.style.display = 'none'; // Nascondi bottone toggle
                chatContainer.classList.remove('aperta'); // Resetta stato
                contenitorePrincipale.classList.remove('chat-attiva'); // Resetta padding
                chatToggleBtn.classList.remove('chat-aperta'); // Resetta posizione bottone
                
                if (mioDato) {
                    zonaProfiloGiocatore.style.display = 'block';
                    profiloEditIcon.style.display = 'inline-block';
                    
                    if (profiloNomeInput.style.display === 'none') {
                        profiloNomeTesto.textContent = mioDato.nome;
                    }
                }
                
                lobbyConteggio.textContent = `Players in lobby: ${giocatori.length}`;
                if (socket.id === hostID) {
                    btnInizia.style.display = 'block';
                    lobbyAttesaHost.textContent = "You are the Host! You can start the game when ready.";
                } else {
                    btnInizia.style.display = 'none';
                    const nomeHost = getNomeGiocatore(hostID);
                    lobbyAttesaHost.textContent = `Waiting for ${nomeHost} to start the game.`;
                }
            } else {
                // Se la partita √® in corso...
                zonaLobby.style.display = 'none';
                zonaProfiloGiocatore.style.display = 'none'; 
                titoloGiocoEl.style.display = 'none';
                btnInizia.style.display = 'none';
                
                if (mioDato && mioDato.inAttesa) {
                    zonaLobby.style.display = 'block'; 
                    lobbyConteggio.textContent = `Game in progress...`;
                    lobbyAttesaHost.textContent = "Waiting for the next round to join the game.";
                    chatToggleBtn.style.display = 'none'; // Nascondi se in attesa
                } else {
                    chatToggleBtn.style.display = 'flex'; // Mostra bottone toggle
                }
            }
        });

        // -----------------------------------------------------------------
        // üÉè LOGICA DI GIOCO
        // -----------------------------------------------------------------
        socket.on('nuovo-turno', (dati) => {
            if (countdownInterval) clearInterval(countdownInterval);
            
            masterCorrenteID = dati.masterID;
            
            zonaLobby.style.display = 'none'; 
            zonaProfiloGiocatore.style.display = 'none'; 
            titoloGiocoEl.style.display = 'none';
            btnInizia.style.display = 'none';
            areaMessaggi.innerHTML = '';
            zonaManoGiocatore.innerHTML = ''; 
            zonaCarteGiocate.innerHTML = '';
            zonaCarteGiocate.style.display = 'none';
            btnAttivaScelta.style.display = 'none'; 
            chatToggleBtn.style.display = 'flex'; // Mostra bottone
            
            zonaCartaNera.style.display = 'block';
            testoCartaNera.textContent = dati.cartaNera;
            
            if (dati.masterID === socket.id) {
                infoMaster.textContent = "You are the Master!";
            } else {
                infoMaster.textContent = `This round's Master is: ${getNomeGiocatore(dati.masterID)}`;
            }
        });
        
        socket.on('aggiorna-stato-ruolo', (dati) => { 
            mioRuolo.isMaster = dati.isMaster;
            if (mioRuolo.isMaster) {
                zonaMaster.textContent = "Waiting for players to choose...";
                zonaMaster.style.display = 'block';
                zonaManoGiocatore.style.display = 'none'; 
            } else {
                zonaMaster.textContent = "Choose your best card.";
                zonaMaster.style.display = 'block';
                zonaManoGiocatore.style.display = 'flex'; 
            }
        });
        socket.on('aggiorna-mano', (mano) => { 
            zonaManoGiocatore.innerHTML = ''; 
            if (mano.length === 0) {
                zonaManoGiocatore.style.display = 'none';
                return;
            }
            zonaManoGiocatore.style.display = 'flex';
            mano.forEach(testoCarta => {
                const cartaDiv = document.createElement('div');
                cartaDiv.className = 'carta-bianca carta-giocabile'; 
                cartaDiv.textContent = testoCarta;
                cartaDiv.addEventListener('click', () => {
                    if (!mioRuolo.isMaster && zonaManoGiocatore.style.display !== 'none') {
                        socket.emit('gioca-carta', testoCarta);
                        zonaManoGiocatore.innerHTML = '<p style="font-size: 1.2em; color: #555;">You played! Waiting for others...</p>';
                        zonaManoGiocatore.style.display = 'block';
                    }
                });
                zonaManoGiocatore.appendChild(cartaDiv);
            });
        });
        
        socket.on('inizia-fase-rivelazione', (data) => {
            console.log("Starting reveal phase, there are", data.numCarte, "cards");
            zonaManoGiocatore.innerHTML = '';
            zonaManoGiocatore.style.display = 'none';
            zonaCarteGiocate.innerHTML = '';
            zonaCarteGiocate.style.display = 'flex';
            
            for (let i = 0; i < data.numCarte; i++) {
                const cartaDiv = document.createElement('div');
                cartaDiv.className = 'carta-coperta';
                cartaDiv.dataset.index = i;
                zonaCarteGiocate.appendChild(cartaDiv);
            }
            
            if (!mioRuolo.isMaster) {
                zonaMaster.textContent = "All players have played! The Master is revealing the cards...";
                zonaMaster.style.display = 'block';
            }
        });

        socket.on('sei-pronto-a-rivelare', () => {
            console.log("Ready to reveal (by clicking cards)");
            zonaMaster.textContent = "Reveal the cards by clicking them!";
            zonaMaster.style.display = 'block';
            
            const carteCoperte = zonaCarteGiocate.querySelectorAll('.carta-coperta');
            carteCoperte.forEach(cartaDiv => {
                cartaDiv.classList.add('cliccabile');
                cartaDiv.onclick = () => {
                    console.log("Master clicked card index:", cartaDiv.dataset.index);
                    socket.emit('rivolgi-carta', { index: cartaDiv.dataset.index });
                    cartaDiv.onclick = null;
                    cartaDiv.classList.remove('cliccabile');
                };
            });
        });

        socket.on('carta-rivelata', (data) => {
            console.log("Card revealed:", data.index, data.testoCarta);
            
            const cartaDaRivelare = zonaCarteGiocate.querySelector(`.carta-coperta[data-index="${data.index}"]`);
            
            if (cartaDaRivelare) {
                const cartaNuova = document.createElement('div');
                cartaNuova.className = 'carta-bianca';
                cartaNuova.dataset.index = data.index;
                cartaNuova.dataset.testo = data.testoCarta;
                cartaNuova.textContent = data.testoCarta;
                
                cartaDaRivelare.replaceWith(cartaNuova);
            }
        });

        socket.on('attendi-scelta-finale', () => {
            console.log("All cards revealed, waiting for Master's choice");
            zonaMaster.textContent = "All cards revealed. Waiting for the Master's choice.";
            zonaMaster.style.display = 'block';
        });

        socket.on('mostra-pulsante-scegli', () => {
            console.log("All cards revealed, showing 'Choose' button");
            zonaMaster.textContent = "All cards are revealed! Press the button to decide.";
            zonaMaster.style.display = 'block';
            btnAttivaScelta.style.display = 'block';
        });
        
        socket.on('annuncia-vincitore', (dati) => {
            masterCorrenteID = dati.vincitoreID;
            
            zonaManoGiocatore.innerHTML = '';
            zonaManoGiocatore.style.display = 'none';
            zonaCarteGiocate.innerHTML = '';
            btnAttivaScelta.style.display = 'none';
            zonaCarteGiocate.style.display = 'flex'; 
            
            zonaCartaNera.style.display = 'block';
            testoCartaNera.textContent = dati.cartaNera;
            
            const cartaVincitriceDiv = document.createElement('div');
            cartaVincitriceDiv.className = 'carta-bianca carta-vincitrice'; 
            cartaVincitriceDiv.textContent = dati.cartaVincitrice;
            zonaCarteGiocate.appendChild(cartaVincitriceDiv);
            
            let messaggio = '';
            const nomeVincitore = getNomeGiocatore(dati.vincitoreID); 
            if (dati.vincitoreID === socket.id) {
                messaggio = "You won this round! You are the new Master.";
                zonaMaster.style.borderColor = "var(--colore-master)";
                zonaMaster.style.color = "var(--colore-giocatore-ha-giocato)";
            } else {
                messaggio = `Player ${nomeVincitore} won! They are the next Master.`; 
                zonaMaster.style.borderColor = "var(--colore-master)";
                zonaMaster.style.color = "var(--colore-testo-scuro)";
            }
            zonaMaster.textContent = messaggio;
            zonaMaster.style.display = 'block';
            
            let timer = dati.countdown || 10;

            if (countdownInterval) clearInterval(countdownInterval);

            infoMaster.textContent = `Next round starts in ${timer}...`; 

            countdownInterval = setInterval(() => {
                timer--;
                if (timer > 0) {
                    infoMaster.textContent = `Next round starts in ${timer}...`;
                } else {
                    infoMaster.textContent = "Starting next round..."; 
                    clearInterval(countdownInterval);
                }
            }, 1000);
        });
        
        // --- Logica della Chat ---
        
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault(); 
            const messaggio = chatInput.value;
            
            if (messaggio.trim() !== '') {
                socket.emit('invia-messaggio-chat', messaggio);
                chatInput.value = '';
            }
        });
        
        socket.on('nuovo-messaggio-chat', (data) => {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'messaggio-chat';
            
            if (data.isSystem) {
                msgDiv.classList.add('sistema');
                msgDiv.textContent = data.messaggio;
            } else {
                const nomeSpan = document.createElement('span');
                nomeSpan.className = 'nome';
                nomeSpan.textContent = `${data.nome}: `;
                
                if (data.nome === getNomeGiocatore(socket.id)) {
                    msgDiv.classList.add('tu');
                }
                
                const testoSpan = document.createElement('span');
                testoSpan.className = 'testo';
                testoSpan.textContent = data.messaggio;
                
                msgDiv.appendChild(nomeSpan);
                msgDiv.appendChild(testoSpan);
            }
            
            chatMessaggiLista.appendChild(msgDiv);
            
            if (!isChatOpen) {
                chatToggleBtn.classList.add('has-new-messages');
            } else {
                chatMessaggiLista.scrollTop = chatMessaggiLista.scrollHeight; 
            }
        });

    </script>

</body>
</html>